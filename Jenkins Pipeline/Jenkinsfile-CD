@Library('github.com/ranjitaws2020/java-shared-library@pipeline') _

pipeline {
    agent any 
     environment {
        azcon = credentials('az_sp')
        IMAGE_NAME = 'javasampletomcat'
        IMAGE_TAG = '10'
        AKS_NAMESPACE = 'default'
        AKS_DEPLOYMENT_NAME = 'aks-deployment-name'
        acrLoginServer = 'myacr032023.azurecr.io'
    }
    tools {
        maven 'maven-home'
        jdk 'jdk8'
        
    }
    stages {
        stage('Pull the file off Nexus') {
            steps{
                  DownloadFromNexus()                    
            }
        }
         stage('Fetch Public IP') {
            steps {
                     FetchPublicIPOfVM()
                
            }
        }
        //stage ('Deploy on this Server') {
        //    steps{
        //        DeployToTomcat()
        //    }            
        //}
         stage('Deploy to AKS') {
            steps {
                script {
                bat label: '', script:"""
                    az login --service-principal -u $azcon_CLIENT_ID -p $azcon_CLIENT_SECRET -t $azcon_TENANT_ID
                    az account set --subscription $azcon_SUBSCRIPTION_ID
                    """
                bat """
                az aks get-credentials --resource-group aks_terraform_rg --name terraform-aks --overwrite-existing
                // az aks get-credentials --resource-group aks_terraform_rg --name terraform-aks                   
                """
                 bat """
                    kubectl apply -f deployment.yaml -n ${AKS_NAMESPACE}
                """
                 bat """
                    kubectl logs deployment/javamaven -n ${AKS_NAMESPACE}
                """


                }
            }
        }
    }
}
