@Library('github.com/ranjitaws2020/java-shared-library@pipeline') _

pipeline {
    agent any
    
    stages {
     
      
        stage('Deploy Artifact') {
          environment {
                SSH_KEY = sh(script: 'cat ./infra/linuxkey.pem', returnStdout: true).trim()
            }
            steps {
                script {
                    sshagent(['SSH_KEY']) {
                        remote {
                            // Set the connection details for the remote host
                            name = 'azurevm'
                            user = 'linuxusr'
                            allowAnyHosts = true
                            host = 'linuxvm'
                            identityFile = SSH_KEY

                            // Execute the Docker commands on the remote host
                            sh "docker build -t javasampletomcat:latest ."
                            sh "docker save javasampletomcat:latest | docker load"
                            sh "docker run -d --name HelloWorld -p 8280:80 javasampletomcat:latest"
                        }
                    }
                }
            }
        }
    }
}
