@Library('github.com/ranjitaws2020/java-shared-library@pipeline') _

pipeline {
    agent any
    
    stages {  
        stage('Provision Infrastructure') {
            steps {
                bat label: '', script: """
                terraform -chdir=infra init -input=false
                terraform -chdir=infra plan -out=tfplan -input=false
                terraform -chdir=infra apply -input=false tfplan   
                """
            }
        }
        stage('Pull the file off Nexus') {
            steps {
                DownloadFromNexus()                  
            }
        }
        stage('Deploy Artifact') {
            steps {
                script {
                   //def sshKey = sh(script: 'cat ./infra/linuxkey.pem', returnStdout: true).trim()

                    sshagent(['SSHKey']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no -i ${SSHKey} linuxusr@linuxvm 'docker build -t javasampletomcat:latest .'
                            ssh -o StrictHostKeyChecking=no -i ${SSHKey} linuxusr@linuxvm 'docker save javasampletomcat:latest | docker load'
                            ssh -o StrictHostKeyChecking=no -i ${SSHKey} linuxusr@linuxvm 'docker run -d --name HelloWorld -p 8280:80 javasampletomcat:latest'
                        """
                    }
                }
            }
        }
    }
}
